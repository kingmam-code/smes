<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上測驗系統</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- XLSX for Excel export functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase (v8 compatibility libraries for easy single-file setup) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- React & Firebase Setup for HTML ---
        // React hooks are available on the global React object
        const { useState, useEffect, useRef, useMemo } = React;

        // Firebase configuration is automatically injected by the environment
        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? JSON.parse(__firebase_config) 
                : { apiKey: "AIzaSyAJY0S4J7kfdrcwSLplDguvwcjNKSpWNwY",
  authDomain: "classtools-5987d.firebaseapp.com",
  projectId: "classtools-5987d" }; // Fallback for local dev
        } catch (e) {
            console.error("Firebase config parsing error:", e);
            firebaseConfig = {};
        }

        // Initialize Firebase using the v8 compatibility syntax
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';

        // --- 主應用程式組件 (App Component) ---
        function App() {
          const [view, setView] = useState('home'); 
          const [user, setUser] = useState(null);
          const [quizState, setQuizState] = useState({ questions: [], theme: '' });
          const [quizResults, setQuizResults] = useState(null);
          const [questionBanks, setQuestionBanks] = useState({});
          const [grades, setGrades] = useState([]);
          const [alert, setAlert] = useState({ show: false, message: ''});
          const [teacherPassword, setTeacherPassword] = useState('');
          const [showPasswordModal, setShowPasswordModal] = useState(false);
          const [showChangePasswordModal, setShowChangePasswordModal] = useState(false);
          const [studentRoster, setStudentRoster] = useState({});
          const [isLoading, setIsLoading] = useState(true);
          const [isAuthReady, setIsAuthReady] = useState(false);

          // Firebase Auth and Data Loading Effect
          useEffect(() => {
            const attemptSignIn = async () => {
              try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                  await auth.signInAnonymously();
                }
              } catch (error) {
                console.error("Firebase sign-in failed:", error);
                showAlert("無法連接到資料庫，請稍後再試。");
                setIsLoading(false);
              }
            };

            const authUnsubscribe = auth.onAuthStateChanged((user) => {
              if (user) {
                setIsAuthReady(true);
              } else {
                attemptSignIn();
              }
            });

            return () => authUnsubscribe();
          }, []);

          useEffect(() => {
            if (!isAuthReady) return;

            const unsubscribes = [];
            const dataPrefix = `artifacts/${appId}/public/data`;

            // 1. 監聽題庫
            const qbUnsubscribe = db.collection(`${dataPrefix}/questionBanks`).onSnapshot((snapshot) => {
                const banks = {};
                snapshot.forEach((doc) => {
                    banks[doc.id] = doc.data();
                });
                setQuestionBanks(banks);
                setIsLoading(false);
            }, (error) => {
                console.error("Error fetching question banks:", error);
                showAlert("讀取題庫時發生錯誤。");
                setIsLoading(false);
            });
            unsubscribes.push(qbUnsubscribe);

            // 2. 監聽成績
            const gradesUnsubscribe = db.collection(`${dataPrefix}/grades`).onSnapshot((snapshot) => {
                const gradesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setGrades(gradesData);
            }, (error) => console.error("Error fetching grades:", error));
            unsubscribes.push(gradesUnsubscribe);

            // 3. 監聽學生名單
            const rosterUnsubscribe = db.collection(`${dataPrefix}/studentRosters`).onSnapshot((snapshot) => {
                const rosters = {};
                snapshot.forEach((doc) => {
                    rosters[doc.id] = doc.data().students || [];
                });
                setStudentRoster(rosters);
            }, (error) => console.error("Error fetching student rosters:", error));
            unsubscribes.push(rosterUnsubscribe);

            // 4. 讀取教師密碼
            const getPassword = async () => {
                const configDocRef = db.doc(`${dataPrefix}/config/teacher`);
                const docSnap = await configDocRef.get();
                if (docSnap.exists) {
                    setTeacherPassword(docSnap.data().password);
                } else {
                    await configDocRef.set({ password: 'htjh' });
                    setTeacherPassword('htjh');
                }
            };
            getPassword();

            return () => unsubscribes.forEach(unsub => unsub());
          }, [isAuthReady]);

          const showAlert = (message) => {
            setAlert({ show: true, message });
          };

          const handleStartQuiz = (student, theme) => {
            setUser({ type: 'student', ...student });
            const originalQuestions = questionBanks[theme]?.questions || [];
            const shuffledQuestions = [...originalQuestions].sort(() => Math.random() - 0.5);
            const randomizedQuiz = shuffledQuestions.map(q => {
                const correctAnswerText = q.options[q.answer];
                const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);
                const newAnswerIndex = shuffledOptions.findIndex(opt => opt === correctAnswerText);
                return { ...q, options: shuffledOptions, answer: newAnswerIndex };
            });
            setQuizState({ questions: randomizedQuiz, theme });
            setView('studentQuiz');
          };

          const handleSubmitQuiz = async (answers) => {
            let score = 0;
            if (quizState.questions.length > 0) {
                quizState.questions.forEach((q, index) => {
                    if (answers[index] === q.answer) {
                        score += 100 / quizState.questions.length;
                    }
                });
            }
            const finalScore = Math.round(score);
            
            const newGrade = {
                class: user.class,
                seat: user.seat,
                name: user.name,
                score: finalScore,
                theme: quizState.theme,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                questions: quizState.questions,
                userAnswers: answers,
            };

            const dataPrefix = `artifacts/${appId}/public/data`;
            try {
                await db.collection(`${dataPrefix}/grades`).add(newGrade);
            } catch (error) {
                console.error("Error saving grade:", error);
                showAlert("儲存成績時發生錯誤。");
            }

            setQuizResults({ score: finalScore, answers });
            setView('studentResults');
          };
          
          const handleTeacherLogin = () => {
              setUser({ type: 'teacher', name: '教師' });
              setView('teacherDashboard');
              return true;
          };

          const handlePasswordCheck = (enteredPassword) => {
            if (enteredPassword === teacherPassword) {
              setShowPasswordModal(false);
              handleTeacherLogin();
            } else {
              showAlert('密碼錯誤！');
            }
          };

          const handleChangePassword = async (oldPassword, newPassword) => {
            if (oldPassword !== teacherPassword) {
              showAlert('舊密碼不正確！');
              return false;
            }
            try {
                const configDocRef = db.doc(`artifacts/${appId}/public/data/config/teacher`);
                await configDocRef.update({ password: newPassword });
                setTeacherPassword(newPassword); 
                setShowChangePasswordModal(false);
                showAlert('密碼更新成功！');
                return true;
            } catch (error) {
                console.error("Error changing password:", error);
                showAlert("更改密碼時發生錯誤。");
                return false;
            }
          };

          const handleLogout = () => {
            setUser(null);
            setQuizResults(null);
            setQuizState({ questions: [], theme: '' });
            setView('home');
          };
          
          if (isLoading) {
            return (
                <div className="bg-slate-100 min-h-screen flex items-center justify-center">
                    <div className="flex flex-col items-center">
                        <div className="animate-spin rounded-full h-24 w-24 border-t-4 border-b-4 border-blue-600"></div>
                        <p className="mt-6 text-xl font-semibold text-blue-600">正在從資料庫載入資料...</p>
                    </div>
                </div>
            )
          }

          const renderContent = () => {
            switch (view) {
              case 'studentQuiz':
                return <QuizView questions={quizState.questions} onSubmit={handleSubmitQuiz} />;
              case 'studentResults':
                return <ResultsView questions={quizState.questions} results={quizResults} onBackHome={handleLogout} />;
              case 'teacherDashboard':
                return <TeacherDashboard 
                            grades={grades} 
                            questionBanks={questionBanks}
                            studentRoster={studentRoster}
                            onLogout={handleLogout} 
                            showAlert={showAlert}
                            onChangePasswordClick={() => setShowChangePasswordModal(true)}
                        />;
              case 'home':
              default:
                return <HomePage 
                            onStartQuiz={handleStartQuiz} 
                            questionBanks={questionBanks} 
                            studentRoster={studentRoster}
                            grades={grades}
                        />;
            }
          };

          return (
            <div className="bg-slate-100 min-h-screen font-sans text-slate-800 flex items-center justify-center p-4">
              <div className="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden relative">
                {alert.show && <AlertModal message={alert.message} onClose={() => setAlert({show: false, message:''})} />}
                {showPasswordModal && <TeacherPasswordModal onLogin={handlePasswordCheck} onCancel={() => setShowPasswordModal(false)} />}
                {showChangePasswordModal && <ChangePasswordModal onSave={handleChangePassword} onCancel={() => setShowChangePasswordModal(false)} />}
                <Header user={user} view={view} onLogout={handleLogout} onTeacherLogin={() => setShowPasswordModal(true)} />
                <main className="p-6 md:p-10">
                  {renderContent()}
                </main>
                <footer className="text-right p-4 text-xs text-slate-400 bg-white">
                    Made by xtjh-yucc
                </footer>
              </div>
            </div>
          );
        }

        // --- 其餘所有組件（保持不變）---
        
        function AlertModal({ message, onClose }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                        <p className="text-lg mb-6 whitespace-pre-wrap">{message}</p>
                        <button
                            onClick={onClose}
                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg"
                        >
                            確定
                        </button>
                    </div>
                </div>
            );
        }

        function Header({ user, view, onLogout, onTeacherLogin }) {
            const getTitle = () => {
                return '線上測驗系統';
            };

            return (
                <header className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 flex justify-between items-center">
                    <h1 className="text-2xl md:text-3xl font-bold">{getTitle()}</h1>
                    <div>
                         {view === 'home' && (
                            <button onClick={onTeacherLogin} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                                教師登入
                            </button>
                        )}
                        {(view.includes('teacher') || view.includes('student')) && (
                            <button onClick={onLogout} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                                登出
                            </button>
                        )}
                    </div>
                </header>
            );
        }

        function HomePage({ onStartQuiz, questionBanks, studentRoster, grades }) {
          const [studentClass, setStudentClass] = useState('');
          const [studentSeat, setStudentSeat] = useState('');
          const [studentName, setStudentName] = useState('');
          const [selectedTheme, setSelectedTheme] = useState(Object.keys(questionBanks)[0] || '');
          const [error, setError] = useState('');
          const themes = Object.keys(questionBanks);
          
          useEffect(() => {
            if(themes.length > 0 && !selectedTheme) {
                setSelectedTheme(themes[0]);
            }
          }, [themes, selectedTheme]);

          useEffect(() => {
              if (studentClass && studentSeat && typeof studentRoster === 'object' && studentRoster[studentClass.trim()]) {
                  const classList = studentRoster[studentClass.trim()];
                  const foundStudent = classList.find(
                      s => String(s.seat) === String(studentSeat.trim())
                  );
                  setStudentName(foundStudent ? foundStudent.name : '');
              } else {
                  setStudentName('');
              }
          }, [studentClass, studentSeat, studentRoster]);

          const handleStudentSubmit = (e) => {
            e.preventDefault();
            setError('');

            if (!studentClass || !studentSeat || !selectedTheme) {
              setError('請輸入班級、座號並選擇測驗主題');
              return;
            }
            
            if (!studentName) {
                setError('查無此學生，請確認班級座號是否已建檔');
                return;
            }

            const themeSettings = questionBanks[selectedTheme];
            const allowRetakes = themeSettings?.allowRetakes || false;

            if (!allowRetakes) {
                const hasTakenQuiz = grades.some(grade => 
                    grade.class === studentClass.trim() && 
                    String(grade.seat) === String(studentSeat.trim()) && 
                    grade.theme === selectedTheme
                );

                if (hasTakenQuiz) {
                    setError(`此主題「${selectedTheme}」只能測驗一次，你已經完成作答。`);
                    return;
                }
            }

            onStartQuiz({ class: studentClass.trim(), seat: studentSeat.trim(), name: studentName }, selectedTheme);
          };

          return (
            <div className="flex justify-center">
                <div className="w-full max-w-md p-6 bg-slate-50 rounded-xl border border-slate-200">
                    <h2 className="text-2xl font-bold mb-4 text-center text-blue-600">學生測驗區</h2>
                    <form onSubmit={handleStudentSubmit} className="space-y-4">
                      <div>
                          <label className="block text-sm font-medium text-slate-600 mb-1">測驗主題</label>
                          <select value={selectedTheme} onChange={e => setSelectedTheme(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                              {themes.length > 0 ? themes.map(theme => <option key={theme} value={theme}>{theme}</option>) : <option disabled>尚無測驗主題</option>}
                          </select>
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-slate-600 mb-1">班級</label>
                          <input
                            type="text" value={studentClass} onChange={(e) => setStudentClass(e.target.value)}
                            placeholder="例如: 701"
                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                      </div>
                      <div>
                          <label className="block text-sm font-medium text-slate-600 mb-1">座號</label>
                          <input
                            type="text" value={studentSeat} onChange={(e) => setStudentSeat(e.target.value)}
                            placeholder="例如: 15"
                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                      </div>
                      <div className="h-6 text-center">
                        {studentName && <p className="font-semibold text-lg text-green-700">歡迎, {studentName} 同學</p>}
                        {!studentName && studentClass && studentSeat && <p className="text-red-600">查無此學生</p>}
                      </div>
                      {error && <p className="text-red-500 text-center text-sm">{error}</p>}
                      <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 disabled:bg-slate-400"
                        disabled={!studentName}
                      >
                          開始測驗
                      </button>
                    </form>
                </div>
            </div>
          );
        }

        function QuizView({ questions, onSubmit }) {
          const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
          const [answers, setAnswers] = useState(Array(questions.length).fill(null));
          const [showConfirmModal, setShowConfirmModal] = useState(false);

          if (!questions || questions.length === 0) {
            return <div className="text-center p-8">此測驗主題沒有題目。</div>;
          }
          
          const handleSelectOption = (optionIndex) => {
            const newAnswers = [...answers];
            newAnswers[currentQuestionIndex] = optionIndex;
            setAnswers(newAnswers);
          };
          
          const handleNext = () => {
              if (currentQuestionIndex < questions.length - 1) {
                  setCurrentQuestionIndex(currentQuestionIndex + 1);
              }
          }

          const handlePrev = () => {
              if (currentQuestionIndex > 0) {
                  setCurrentQuestionIndex(currentQuestionIndex - 1);
              }
          }
          
          const handleSubmitClick = () => {
              const unanswered = answers.filter(a => a === null).length;
              if (unanswered > 0) {
                  setShowConfirmModal(true);
              } else {
                  onSubmit(answers);
              }
          }

          const handleConfirmSubmit = () => {
              onSubmit(answers);
              setShowConfirmModal(false);
          }

          const currentQuestion = questions[currentQuestionIndex];
          const progress = ((currentQuestionIndex + 1) / questions.length) * 100;

          return (
            <div>
                {showConfirmModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                            <h3 className="text-lg font-bold mb-4">確定要交卷嗎？</h3>
                            <p>還有 {answers.filter(a => a === null).length} 題未作答，確定要交卷嗎？</p>
                            <div className="flex justify-end gap-4 mt-6">
                                <button onClick={() => setShowConfirmModal(false)} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                                <button onClick={handleConfirmSubmit} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">確定交卷</button>
                            </div>
                        </div>
                    </div>
                )}
                <div className="mb-6">
                    <div className="bg-slate-200 rounded-full h-4">
                        <div className="bg-green-500 h-4 rounded-full" style={{ width: `${progress}%` }}></div>
                    </div>
                    <p className="text-center text-sm text-slate-600 mt-2">進度: {currentQuestionIndex + 1} / {questions.length}</p>
                </div>
                <div className="bg-slate-50 p-6 rounded-lg border border-slate-200">
                    <h3 className="text-xl font-semibold mb-4">
                        {`第 ${currentQuestionIndex + 1} 題: ${currentQuestion.text}`}
                    </h3>
                    <div className="space-y-3">
                    {currentQuestion.options.map((option, index) => (
                        <label key={index} className={`flex items-center p-4 rounded-lg border-2 cursor-pointer transition ${answers[currentQuestionIndex] === index ? 'bg-blue-100 border-blue-500' : 'bg-white border-slate-300 hover:border-blue-400'}`}>
                        <input
                            type="radio"
                            name={`question-${currentQuestionIndex}`}
                            checked={answers[currentQuestionIndex] === index}
                            onChange={() => handleSelectOption(index)}
                            className="w-5 h-5 text-blue-600 focus:ring-blue-500"
                        />
                        <span className="ml-4 text-lg">{option}</span>
                        </label>
                    ))}
                    </div>
                </div>
                <div className="mt-8 flex justify-between items-center">
                    <button onClick={handlePrev} disabled={currentQuestionIndex === 0} className="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed transition">
                        上一題
                    </button>
                    {currentQuestionIndex === questions.length - 1 ? (
                        <button onClick={handleSubmitClick} className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 animate-pulse">
                            完成並交卷
                        </button>
                    ) : (
                        <button onClick={handleNext} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                            下一題
                        </button>
                    )}
                </div>
            </div>
          );
        }

        function ResultsView({ questions, results, onBackHome }) {
          const { score, answers } = results;

          const getScoreColor = (s) => {
            if (s >= 80) return 'text-green-600';
            if (s >= 60) return 'text-yellow-600';
            return 'text-red-600';
          };

          return (
            <div className="text-center">
              <h2 className="text-3xl font-bold mb-2">測驗完成！</h2>
              <p className="text-5xl font-bold mb-6">
                你的分數: <span className={getScoreColor(score)}>{score}</span>
              </p>
              
              <div className="mt-8 text-left space-y-6 max-h-[50vh] overflow-y-auto pr-4">
                {questions.map((q, index) => {
                  const userAnswer = answers[index];
                  const isCorrect = userAnswer === q.answer;
                  return (
                    <div key={q.id || index} className={`p-4 rounded-lg border-2 ${isCorrect ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50'}`}>
                      <p className="font-bold text-lg">{`${index + 1}. ${q.text}`}</p>
                      <p className="mt-2">你的答案: <span className={`font-semibold ${isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                        {userAnswer !== null ? q.options[userAnswer] : '未作答'}
                        {isCorrect ? ' (正確)' : ' (錯誤)'}
                      </span></p>
                      {!isCorrect && <p className="mt-1">正確答案: <span className="font-semibold text-blue-700">{q.options[q.answer]}</span></p>}
                      <p className="mt-2 text-sm text-slate-600 bg-slate-100 p-2 rounded">
                          <span className="font-bold">解析:</span> {q.explanation}
                      </p>
                    </div>
                  );
                })}
              </div>

              <button onClick={onBackHome} className="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105">
                返回首頁
              </button>
            </div>
          );
        }

        function TeacherDashboard({ grades, questionBanks, studentRoster, showAlert, onLogout, onChangePasswordClick }) {
            const [tab, setTab] = useState('questions');
            const [currentTheme, setCurrentTheme] = useState(Object.keys(questionBanks)[0] || null);
            const [showAddThemeModal, setShowAddThemeModal] = useState(false);
            const [deletingTheme, setDeletingTheme] = useState(null);
            const dataPrefix = `artifacts/${appId}/public/data`;

            useEffect(() => {
                if (!currentTheme && Object.keys(questionBanks).length > 0) {
                    setCurrentTheme(Object.keys(questionBanks)[0]);
                }
            }, [questionBanks, currentTheme]);

            const handleAddTheme = async (newThemeName) => {
                if (newThemeName && !questionBanks[newThemeName]) {
                    try {
                        await db.collection(`${dataPrefix}/questionBanks`).doc(newThemeName).set({ 
                            questions: [],
                            allowRetakes: false 
                        });
                        setCurrentTheme(newThemeName);
                        setShowAddThemeModal(false);
                        showAlert(`主題 "${newThemeName}" 新增成功！`);
                    } catch (error) {
                        console.error("Error adding theme:", error);
                        showAlert("新增主題時發生錯誤。");
                    }
                } else if (newThemeName) {
                    showAlert('主題名稱已存在或無效！');
                }
            };

            const handleDeleteTheme = async () => {
                if (!deletingTheme) return;
                try {
                    await db.collection(`${dataPrefix}/questionBanks`).doc(deletingTheme).delete();
                    const remainingKeys = Object.keys(questionBanks).filter(k => k !== deletingTheme);
                    if (currentTheme === deletingTheme) {
                        setCurrentTheme(remainingKeys.length > 0 ? remainingKeys[0] : null);
                    }
                    showAlert(`主題 "${deletingTheme}" 已成功刪除。`);
                    setDeletingTheme(null);
                } catch (error) {
                    console.error("Error deleting theme:", error);
                    showAlert("刪除主題時發生錯誤。");
                }
            };

            const handleSetQuestions = async (updater) => {
                if (!currentTheme) return;
                try {
                    const currentBank = questionBanks[currentTheme] || { questions: [], allowRetakes: false };
                    const newQuestions = typeof updater === 'function' ? updater(currentBank.questions) : updater;
                    const themeDocRef = db.collection(`${dataPrefix}/questionBanks`).doc(currentTheme);
                    await themeDocRef.update({ questions: newQuestions });
                } catch (error) {
                    console.error("Error updating questions:", error);
                    showAlert("更新題庫時發生錯誤。");
                }
            };
            
            const handleUpdateThemeSettings = async (newSettings) => {
                if (!currentTheme) return;
                try {
                    const themeDocRef = db.collection(`${dataPrefix}/questionBanks`).doc(currentTheme);
                    await themeDocRef.update(newSettings);
                    showAlert("主題設定更新成功！");
                } catch (error) {
                    console.error("Error updating theme settings:", error);
                    showAlert("更新主題設定時發生錯誤。");
                }
            };

            const RetakeIcon = () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="inline-block mr-1 text-green-500" title="允許重複測驗">
                    <polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
            );

            return (
                <div className="flex flex-col md:flex-row gap-8">
                     {showAddThemeModal && <AddThemeModal onSave={handleAddTheme} onCancel={() => setShowAddThemeModal(false)} />}
                     {deletingTheme && <DeleteThemeModal themeName={deletingTheme} onConfirm={handleDeleteTheme} onCancel={() => setDeletingTheme(null)} />}
                    <aside className="w-full md:w-1/4 border-b md:border-b-0 md:border-r pb-6 md:pb-0 md:pr-6">
                        <h2 className="text-lg font-bold mb-4">管理選單</h2>
                        <div className="space-y-2">
                            {Object.keys(questionBanks).map(theme => (
                                <div key={theme} className="group flex items-center justify-between bg-slate-100 rounded-lg hover:bg-slate-200">
                                     <button onClick={() => { setCurrentTheme(theme); setTab('questions'); }}
                                        className={`flex-grow text-left p-3 rounded-lg transition ${currentTheme === theme && tab === 'questions' ? 'bg-blue-600 text-white' : 'bg-transparent'}`}>
                                        {questionBanks[theme]?.allowRetakes && <RetakeIcon />}
                                        {theme} ({questionBanks[theme]?.questions?.length || 0})
                                    </button>
                                    <button 
                                        onClick={() => setDeletingTheme(theme)} 
                                        className="p-2 text-slate-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                        title={`刪除 ${theme} 主題`}
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    </button>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => setShowAddThemeModal(true)} className="w-full mt-4 p-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold">
                            ＋ 新增主題
                        </button>
                        <button onClick={onChangePasswordClick} className="w-full mt-2 p-2 bg-slate-500 hover:bg-slate-600 text-white rounded-lg font-semibold">
                            修改密碼
                        </button>
                    </aside>
                    <main className="w-full md:w-3/4">
                        <div className="flex border-b border-slate-200 mb-6 flex-wrap">
                            <button onClick={() => setTab('questions')} className={`px-6 py-3 font-semibold text-lg ${tab === 'questions' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-slate-500'}`}>
                                題庫管理
                            </button>
                            <button onClick={() => setTab('grades')} className={`px-6 py-3 font-semibold text-lg ${tab === 'grades' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-slate-500'}`}>
                                成績總覽
                            </button>
                             <button onClick={() => setTab('roster')} className={`px-6 py-3 font-semibold text-lg ${tab === 'roster' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-slate-500'}`}>
                                學生名單
                            </button>
                            <button onClick={() => setTab('data')} className={`px-6 py-3 font-semibold text-lg ${tab === 'data' ? 'border-b-4 border-blue-600 text-blue-600' : 'text-slate-500'}`}>
                                資料管理
                            </button>
                        </div>
                        <div>
                            {tab === 'grades' && <GradebookView grades={grades} themes={Object.keys(questionBanks)} showAlert={showAlert} />}
                            {tab === 'questions' && (currentTheme ? 
                                <QuestionBankView 
                                    key={currentTheme}
                                    questions={questionBanks[currentTheme]?.questions || []}
                                    grades={grades}
                                    themeSettings={questionBanks[currentTheme]}
                                    setQuestions={handleSetQuestions}
                                    onUpdateThemeSettings={handleUpdateThemeSettings}
                                    showAlert={showAlert}
                                    themeName={currentTheme}
                                /> : <p>請從左側選單選擇一個主題來管理題目。</p>)
                            }
                            {tab === 'roster' && <StudentRosterView studentRoster={studentRoster} grades={grades} showAlert={showAlert} />}
                            {tab === 'data' && <DataManagementView showAlert={showAlert} />}
                        </div>
                    </main>
                </div>
            );
        }

        function StudentRosterView({ studentRoster, grades, showAlert }) {
            const [isAddClassModalOpen, setIsAddClassModalOpen] = useState(false);
            const [classToDelete, setClassToDelete] = useState(null);
            const [studentToEdit, setStudentToEdit] = useState(null); 
            const [studentToDelete, setStudentToDelete] = useState(null);
            const [classForNewStudent, setClassForNewStudent] = useState(null);
            const fileInputRef = useRef(null);
            const [classToImportInto, setClassToImportInto] = useState(null);
            const [expandedClasses, setExpandedClasses] = useState({});
            const dataPrefix = `artifacts/${appId}/public/data`;

            const toggleExpand = (classKey) => {
                setExpandedClasses(prev => ({ ...prev, [classKey]: !prev[classKey] }));
            };

            const handleAddClass = async (className) => {
                if (!className) {
                    showAlert("班級名稱不能為空！");
                    return;
                }
                if (studentRoster[className]) {
                    showAlert(`班級 "${className}" 已存在！`);
                    return;
                }
                try {
                    await db.collection(`${dataPrefix}/studentRosters`).doc(className).set({ students: [] });
                    showAlert(`班級 "${className}" 新增成功！`);
                    setIsAddClassModalOpen(false);
                } catch (error) {
                    console.error("Error adding class:", error);
                    showAlert("新增班級時發生錯誤。");
                }
            };

            const handleDeleteClass = async () => {
                if (!classToDelete) return;
                try {
                    const batch = db.batch();
                    batch.delete(db.doc(`${dataPrefix}/studentRosters/${classToDelete}`));
                    const gradesQuery = await db.collection(`${dataPrefix}/grades`).where('class', '==', classToDelete).get();
                    gradesQuery.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    showAlert(`班級 "${classToDelete}" 及其所有學生和成績資料已刪除。`);
                    setClassToDelete(null);
                } catch (error) {
                    console.error("Error deleting class:", error);
                    showAlert("刪除班級時發生錯誤。");
                }
            };

            const handleSaveStudent = async (classKey, studentData, originalSeat) => {
                const classList = studentRoster[classKey] || [];
                const isEditing = originalSeat !== undefined;
                const seatExists = classList.some(s => s.seat === studentData.seat && (!isEditing || s.seat !== originalSeat));
                if (seatExists) {
                    showAlert(`座號 "${studentData.seat}" 在此班級已存在！`);
                    return;
                }
                
                try {
                    const classDocRef = db.doc(`${dataPrefix}/studentRosters/${classKey}`);
                    const newClassList = isEditing 
                        ? classList.map(s => (s.seat === originalSeat ? studentData : s)) 
                        : [...classList, studentData];
                    newClassList.sort((a, b) => parseInt(a.seat) - parseInt(b.seat));

                    await classDocRef.update({ students: newClassList });
                    showAlert(isEditing ? '學生資料更新成功！' : '新增學生成功！');
                    setStudentToEdit(null);
                    setClassForNewStudent(null);
                } catch (error) {
                    console.error("Error saving student:", error);
                    showAlert("儲存學生資料時發生錯誤。");
                }
            };
            
            const handleDeleteStudent = async () => {
                if (!studentToDelete) return;
                const { classKey, student } = studentToDelete;
                try {
                    const batch = db.batch();
                    const classDocRef = db.doc(`${dataPrefix}/studentRosters/${classKey}`);
                    const newClassList = studentRoster[classKey].filter(s => s.seat !== student.seat);
                    batch.update(classDocRef, { students: newClassList });

                    const gradesQuery = await db.collection(`${dataPrefix}/grades`).where('class', '==', classKey).where('seat', '==', student.seat).get();
                    gradesQuery.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    showAlert(`已從 ${classKey} 班刪除學生 ${student.name} 及其成績資料。`);
                    setStudentToDelete(null);
                } catch (error) {
                    console.error("Error deleting student:", error);
                    showAlert("刪除學生時發生錯誤。");
                }
            };

            const handleDownloadExample = () => {
                if (typeof XLSX === 'undefined') {
                    showAlert('錯誤：匯出功能所需的函式庫 (xlsx) 未載入。'); return;
                }
                const headers = ["seat", "name"];
                const exampleData = [ ["1", "王小明"], ["2", "陳大華"] ];
                const ws = XLSX.utils.aoa_to_sheet([headers, ...exampleData]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "學生名單範例");
                XLSX.writeFile(wb, "student_import_template.xlsx");
            };

            const triggerFileUpload = (classKey) => {
                setClassToImportInto(classKey);
                fileInputRef.current.click();
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file || !classToImportInto) return;

                if (typeof XLSX === 'undefined') {
                    showAlert('錯誤：所需函式庫 (xlsx) 未載入，無法解析檔案。');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        if (json.length === 0) { showAlert('檔案為空或格式不符。'); return; }

                        const existingStudents = studentRoster[classToImportInto] || [];
                        const existingSeats = new Set(existingStudents.map(s => String(s.seat)));
                        const studentsToAdd = [];
                        const skippedStudents = [];

                        json.forEach(row => {
                            const seat = row.seat ? String(row.seat).trim() : '';
                            const name = row.name ? String(row.name).trim() : '';
                            if (!seat || !name) return;
                            if (existingSeats.has(seat)) {
                                skippedStudents.push({ seat, name });
                            } else {
                                studentsToAdd.push({ seat, name });
                                existingSeats.add(seat);
                            }
                        });
                        
                        if (studentsToAdd.length > 0) {
                            const updatedClassList = [...existingStudents, ...studentsToAdd].sort((a, b) => parseInt(a.seat) - parseInt(b.seat));
                            await db.doc(`${dataPrefix}/studentRosters/${classToImportInto}`).update({ students: updatedClassList });
                        }

                        let alertMessage = '';
                        if (studentsToAdd.length > 0) alertMessage += `成功匯入 ${studentsToAdd.length} 位新學生至 ${classToImportInto} 班。`;
                        if (skippedStudents.length > 0) alertMessage += `\n${skippedStudents.length} 位學生因座號重複被略過。`;
                        if (!alertMessage) alertMessage = '檔案中無有效的新學生資料可匯入。';
                        showAlert(alertMessage.trim());

                    } catch (error) {
                        showAlert(`檔案處理失敗：${error.message}`);
                    } finally {
                        e.target.value = '';
                        setClassToImportInto(null);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div>
                    {isAddClassModalOpen && <AddClassModal onSave={handleAddClass} onCancel={() => setIsAddClassModalOpen(false)} />}
                    {classToDelete && <ConfirmDeleteModal title="確認刪除班級" message={`您確定要刪除「${classToDelete}」班嗎？此班級內所有學生資料及其相關的測驗成績將會被一併移除。`} onConfirm={handleDeleteClass} onCancel={() => setClassToDelete(null)} />}
                    {(studentToEdit || classForNewStudent) && <AddEditStudentModal 
                        classKey={studentToEdit?.classKey || classForNewStudent}
                        student={studentToEdit?.student}
                        onSave={handleSaveStudent}
                        onCancel={() => { setStudentToEdit(null); setClassForNewStudent(null); }}
                    />}
                    {studentToDelete && <ConfirmDeleteModal title="確認刪除學生" message={`您確定要從 ${studentToDelete.classKey} 班刪除 ${studentToDelete.student.name} (座號: ${studentToDelete.student.seat}) 嗎？`} onConfirm={handleDeleteStudent} onCancel={() => setStudentToDelete(null)} />}
                    
                    <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".xlsx" style={{ display: 'none' }} />

                    <div className="flex justify-between items-center mb-6 flex-wrap gap-2">
                         <h3 className="text-xl font-bold">管理學生名單</h3>
                         <div className="flex gap-2">
                            <button onClick={handleDownloadExample} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">下載範例檔</button>
                            <button onClick={() => setIsAddClassModalOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">＋ 新增班級</button>
                         </div>
                    </div>

                    <div className="space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                        {Object.keys(studentRoster).length > 0 ? Object.keys(studentRoster).sort().map(classKey => (
                            <div key={classKey} className="p-4 bg-slate-50 rounded-lg border">
                                <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                                    <h4 className="text-lg font-bold">{classKey} 班</h4>
                                     <div className="flex gap-2 items-center">
                                        <button onClick={() => toggleExpand(classKey)} className="bg-slate-400 hover:bg-slate-500 text-white text-sm font-bold py-1 px-3 rounded-md">
                                            {expandedClasses[classKey] ? '隱藏學生' : '查看學生'}
                                        </button>
                                        <button onClick={() => triggerFileUpload(classKey)} className="bg-teal-500 hover:bg-teal-600 text-white text-sm font-bold py-1 px-3 rounded-md">匯入 Excel</button>
                                        <button onClick={() => setClassForNewStudent(classKey)} className="bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-md">新增學生</button>
                                        <button onClick={() => setClassToDelete(classKey)} className="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded-md">刪除班級</button>
                                    </div>
                                </div>
                                {expandedClasses[classKey] && (
                                    studentRoster[classKey].length > 0 ? (
                                        <table className="w-full text-left bg-white">
                                            <thead>
                                                <tr className="bg-slate-200">
                                                    <th className="p-2 w-1/4">座號</th>
                                                    <th className="p-2 w-1/2">姓名</th>
                                                    <th className="p-2 w-1/4 text-right">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {studentRoster[classKey].map(student => (
                                                    <tr key={student.seat} className="border-b">
                                                        <td className="p-2">{student.seat}</td>
                                                        <td className="p-2">{student.name}</td>
                                                        <td className="p-2 text-right">
                                                            <button onClick={() => setStudentToEdit({ classKey, student })} className="text-sm text-blue-600 hover:underline mr-4">編輯</button>
                                                            <button onClick={() => setStudentToDelete({ classKey, student })} className="text-sm text-red-600 hover:underline">刪除</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    ) : (
                                        <p className="text-center text-slate-500 py-4">此班級尚無學生資料</p>
                                    )
                                )}
                            </div>
                        )) : (
                             <p className="text-center text-slate-500 py-8">尚未建立任何班級，請點擊「新增班級」開始。</p>
                        )}
                    </div>
                </div>
            );
        }

        function GradebookView({ grades, themes, showAlert }) {
            const [selectedTheme, setSelectedTheme] = useState('all');
            const [selectedClass, setSelectedClass] = useState('all');
            const [selectedGrade, setSelectedGrade] = useState(null);

            const uniqueClasses = ['all', ...[...new Set(grades.map(g => g.class))].sort()];
            
            const filteredAndSortedGrades = useMemo(() => grades
                .filter(g => 
                    (selectedClass === 'all' || g.class === selectedClass) &&
                    (selectedTheme === 'all' || g.theme === selectedTheme)
                )
                .sort((a, b) => {
                    const dateA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
                    const dateB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
                    return dateB - dateA;
                }), [grades, selectedClass, selectedTheme]);

            const handleExportXLSX = () => {
                if (typeof XLSX === 'undefined') {
                    showAlert('錯誤：匯出功能所需的函式庫 (xlsx) 未載入。'); return;
                }
                if (filteredAndSortedGrades.length === 0) {
                    showAlert('沒有符合篩選條件的成績可匯出。'); return;
                }
                const headers = ["主題", "班級", "座號", "姓名", "分數", "測驗時間"];
                const dataToExport = filteredAndSortedGrades.map(grade => [
                    grade.theme, 
                    grade.class, 
                    grade.seat, 
                    grade.name, 
                    grade.score,
                    grade.timestamp?.toDate ? grade.timestamp.toDate().toLocaleString('zh-TW') : 'N/A'
                ]);
                const ws = XLSX.utils.aoa_to_sheet([headers, ...dataToExport]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "學生乘績");
                const fileName = `成績_${selectedClass === 'all' ? '全部班級' : `${selectedClass}班`}_${selectedTheme === 'all' ? '全部主題' : selectedTheme}.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            return (
                <div>
                    {selectedGrade && <GradeDetailsModal grade={selectedGrade} onClose={() => setSelectedGrade(null)} />}
                    <div className="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <div className="flex items-center gap-4 flex-wrap">
                            <div>
                                <label className="mr-2 font-semibold">選擇班級:</label>
                                <select value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)} className="p-2 border border-slate-300 rounded-lg">
                                    {uniqueClasses.map(c => <option key={c} value={c}>{c === 'all' ? '全部班級' : `${c}班`}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="mr-2 font-semibold">選擇主題:</label>
                                <select value={selectedTheme} onChange={(e) => setSelectedTheme(e.target.value)} className="p-2 border border-slate-300 rounded-lg">
                                    <option value="all">所有主題</option>
                                    {themes.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>
                        </div>
                        <button 
                            onClick={handleExportXLSX}
                            className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            匯出為 .xlsx
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-max text-left border-collapse">
                            <thead>
                                <tr className="bg-slate-100">
                                    <th className="p-3 border-b-2 border-slate-200 font-bold">主題</th>
                                    <th className="p-3 border-b-2 border-slate-200 font-bold">班級</th>
                                    <th className="p-3 border-b-2 border-slate-200 font-bold">座號</th>
                                    <th className="p-3 border-b-2 border-slate-200 font-bold">姓名</th>
                                    <th className="p-3 border-b-2 border-slate-200 font-bold">分數</th>
                                    <th className="p-3 border-b-2 border-slate-200 font-bold">測驗時間</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredAndSortedGrades.map((grade, index) => (
                                    <tr key={grade.id || index} className="hover:bg-slate-50 cursor-pointer" onClick={() => setSelectedGrade(grade)}>
                                        <td className="p-3 border-b border-slate-200">{grade.theme}</td>
                                        <td className="p-3 border-b border-slate-200">{grade.class}</td>
                                        <td className="p-3 border-b border-slate-200">{grade.seat}</td>
                                        <td className="p-3 border-b border-slate-200">{grade.name}</td>
                                        <td className={`p-3 border-b border-slate-200 font-bold ${grade.score >= 60 ? 'text-green-600' : 'text-red-500'}`}>{grade.score}</td>
                                        <td className="p-3 border-b border-slate-200 text-sm text-slate-600">{grade.timestamp?.toDate ? grade.timestamp.toDate().toLocaleString('zh-TW') : 'N/A'}</td>
                                    </tr>
                                ))}
                                 {filteredAndSortedGrades.length === 0 && (
                                    <tr>
                                        <td colSpan="6" className="text-center p-8 text-slate-500">沒有符合條件的成績紀錄</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function GradeDetailsModal({ grade, onClose }) {
            if (!grade) return null;

            const { score, userAnswers, questions } = grade;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl" onClick={e => e.stopPropagation()}>
                        <header className="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-lg">
                            <h3 className="text-xl font-bold">
                                {`${grade.class}班 ${grade.seat}號 ${grade.name} - ${grade.theme}`}
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-800 p-1 rounded-full hover:bg-slate-200">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </header>
                        <main className="p-6 max-h-[70vh] overflow-y-auto">
                            <h4 className="text-2xl font-bold text-center mb-6">測驗分數: {score}</h4>
                            <div className="space-y-4">
                                {!questions || !userAnswers ? (
                                    <p className="text-center text-slate-500 py-8">此筆成績無詳細作答紀錄。</p>
                                ) : (
                                    questions.map((q, index) => {
                                        const userAnswer = userAnswers[index];
                                        const isCorrect = userAnswer === q.answer;
                                        return (
                                            <div key={index} className={`p-3 rounded-lg border-2 ${isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}`}>
                                                <p className="font-bold">{`${index + 1}. ${q.text}`}</p>
                                                <p className="mt-1">學生答案: <span className={`font-semibold ${isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                                                    {userAnswer !== null ? q.options[userAnswer] : '未作答'}
                                                </span></p>
                                                {!isCorrect && <p className="mt-1">正確答案: <span className="font-semibold text-blue-700">{q.options[q.answer]}</span></p>}
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        function DataManagementView({ showAlert }) {
            const [isLoading, setIsLoading] = useState(false);
            const [showImportConfirm, setShowImportConfirm] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [fileToImport, setFileToImport] = useState(null);
            const importFileRef = useRef(null);
            const dataPrefix = `artifacts/${appId}/public/data`;

            const handleExportData = async () => {
                setIsLoading(true);
                showAlert("正在準備匯出資料...");
                try {
                    const collectionsToExport = {
                        questionBanks: {},
                        grades: [],
                        studentRosters: {},
                    };

                    const qbSnapshot = await db.collection(`${dataPrefix}/questionBanks`).get();
                    qbSnapshot.forEach(doc => {
                        collectionsToExport.questionBanks[doc.id] = doc.data();
                    });

                    const gradesSnapshot = await db.collection(`${dataPrefix}/grades`).get();
                    gradesSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.timestamp && data.timestamp.toDate) {
                            data.timestamp = data.timestamp.toDate().toISOString();
                        }
                        collectionsToExport.grades.push(data);
                    });

                    const rosterSnapshot = await db.collection(`${dataPrefix}/studentRosters`).get();
                    rosterSnapshot.forEach(doc => {
                        collectionsToExport.studentRosters[doc.id] = doc.data();
                    });

                    const jsonString = JSON.stringify(collectionsToExport, null, 2);
                    const blob = new Blob([jsonString], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `quiz-backup-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showAlert("資料已成功匯出！");

                } catch (error) {
                    console.error("Export error:", error);
                    showAlert(`資料匯出失敗: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleImportFileSelect = (e) => {
                const file = e.target.files[0];
                if (file && file.type === "application/json") {
                    setFileToImport(file);
                    setShowImportConfirm(true);
                } else if (file) {
                    showAlert("檔案格式錯誤，請選擇 .json 格式的備份檔。");
                }
                e.target.value = null;
            };

            const handleConfirmImport = () => {
                if (!fileToImport) return;
                setShowImportConfirm(false);
                setIsLoading(true);

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data.questionBanks || !data.grades || !data.studentRosters) {
                            throw new Error("備份檔內容格式不符。");
                        }
                        
                        const collectionsToDelete = ['questionBanks', 'grades', 'studentRosters'];
                        const deleteBatch = db.batch();
                        for (const collName of collectionsToDelete) {
                            const snapshot = await db.collection(`${dataPrefix}/${collName}`).get();
                            snapshot.docs.forEach(doc => deleteBatch.delete(doc.ref));
                        }
                        await deleteBatch.commit();
                        
                        const importBatch = db.batch();
                        Object.entries(data.questionBanks).forEach(([id, qbData]) => {
                            importBatch.set(db.doc(`${dataPrefix}/questionBanks/${id}`), qbData);
                        });
                         Object.entries(data.studentRosters).forEach(([id, rosterData]) => {
                            importBatch.set(db.doc(`${dataPrefix}/studentRosters/${id}`), rosterData);
                        });
                        data.grades.forEach(gradeData => {
                            if (gradeData.timestamp && typeof gradeData.timestamp === 'string') {
                                gradeData.timestamp = new Date(gradeData.timestamp);
                            }
                            const newDocRef = db.collection(`${dataPrefix}/grades`).doc();
                            importBatch.set(newDocRef, gradeData);
                        });

                        await importBatch.commit();

                        showAlert("資料匯入成功！頁面將在3秒後重新整理以載入新資料。");
                        setTimeout(() => window.location.reload(), 3000);

                    } catch (error) {
                        console.error("Import error:", error);
                        showAlert(`資料匯入失敗: ${error.message}`);
                        setIsLoading(false);
                    }
                };
                reader.readAsText(fileToImport);
            };

            const handleConfirmDeleteAll = async () => {
                setShowDeleteConfirm(false);
                setIsLoading(true);
                try {
                     const collectionsToDelete = ['questionBanks', 'grades', 'studentRosters'];
                     let batch = db.batch();
                     for (const collName of collectionsToDelete) {
                         const snapshot = await db.collection(`${dataPrefix}/${collName}`).get();
                         snapshot.docs.forEach(doc => batch.delete(doc.ref));
                     }
                     await batch.commit();
                     showAlert("所有資料已成功刪除！頁面將在3秒後重新整理。");
                     setTimeout(() => window.location.reload(), 3000);
                } catch (error) {
                    console.error("Delete error:", error);
                    showAlert(`刪除資料時發生錯誤: ${error.message}`);
                    setIsLoading(false);
                }
            };

            return (
                <div className="relative space-y-8">
                    {isLoading && <LoadingSpinner />}
                    {showImportConfirm && <ConfirmDeleteModal 
                        title="確認匯入資料"
                        message="匯入資料將會先刪除所有現有資料（題庫、學生、成績），然後再載入備份檔。此操作無法復原，您確定要繼續嗎？"
                        onConfirm={handleConfirmImport}
                        onCancel={() => setShowImportConfirm(false)}
                    />}
                    {showDeleteConfirm && <ConfirmDeleteModal 
                        title="確認刪除所有資料"
                        message="您確定要刪除所有題庫、學生名單及成績資料嗎？此操作將無法復原，強烈建議您先匯出備份。"
                        onConfirm={handleConfirmDeleteAll}
                        onCancel={() => setShowDeleteConfirm(false)}
                    />}
                    <input type="file" ref={importFileRef} onChange={handleImportFileSelect} accept=".json" className="hidden" />

                    <div className="p-6 bg-slate-50 rounded-lg border border-slate-200">
                        <h3 className="text-xl font-bold mb-2">匯出所有資料</h3>
                        <p className="text-slate-600 mb-4">將所有題庫、學生名單及成績紀錄匯出成一個 .json 備份檔。</p>
                        <button onClick={handleExportData} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                            開始匯出
                        </button>
                    </div>
                    
                    <div className="p-6 bg-slate-50 rounded-lg border border-slate-200">
                        <h3 className="text-xl font-bold mb-2">從備份檔匯入資料</h3>
                        <p className="text-slate-600 mb-4">
                            <span className="font-bold text-red-600">警告：</span>
                            此操作將會<span className="font-bold">清除所有現有資料</span>，再從您選擇的 .json 備份檔中匯入。
                        </p>
                        <button onClick={() => importFileRef.current.click()} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">
                            選擇檔案並匯入
                        </button>
                    </div>

                    <div className="p-6 bg-red-50 rounded-lg border border-red-300">
                         <h3 className="text-xl font-bold text-red-800 mb-2">刪除所有資料</h3>
                        <p className="text-red-700 mb-4">
                             <span className="font-bold">極度危險操作：</span>
                             此操作將永久刪除系統中<span className="font-bold">所有的題庫、學生名單與成績紀錄</span>。此動作無法復原！
                        </p>
                        <button onClick={() => setShowDeleteConfirm(true)} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">
                            刪除全部資料
                        </button>
                    </div>

                </div>
            );
        }

        function QuestionBankView({ questions, grades, setQuestions, showAlert, themeName, themeSettings, onUpdateThemeSettings }) {
            const [importMethod, setImportMethod] = useState('manual');
            const [aiTopic, setAiTopic] = useState('');
            const [numAiQuestions, setNumAiQuestions] = useState(5);
            const [isSimulatingAi, setIsSimulatingAi] = useState(false);
            const fileInputRef = useRef(null);
            const [editingQuestion, setEditingQuestion] = useState(null);
            const [deletingQuestionId, setDeletingQuestionId] = useState(null);

            const questionStats = useMemo(() => {
                const stats = {};
                questions.forEach(q => {
                    stats[q.text] = { attempts: 0, correct: 0 };
                });
                grades.forEach(grade => {
                    if (grade.theme === themeName && Array.isArray(grade.questions) && Array.isArray(grade.userAnswers)) {
                        grade.questions.forEach((q, index) => {
                            if (stats[q.text] !== undefined) {
                                stats[q.text].attempts++;
                                if (grade.userAnswers[index] === q.answer) {
                                    stats[q.text].correct++;
                                }
                            }
                        });
                    }
                });
                return stats;
            }, [questions, grades, themeName]);

            const handleRetakeToggle = () => {
                const newSetting = !themeSettings.allowRetakes;
                onUpdateThemeSettings({ allowRetakes: newSetting });
            };

            const handleAiGenerateByTopic = async () => {
                if (!aiTopic.trim()) {
                    showAlert('請輸入一個主題！');
                    return;
                }
                setIsSimulatingAi(true);

                try {
                    const apiKey = "AIzaSyBrtW4nSsHfW8nExlIOSsLdZXnaPjVpwcM";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const prompt = `請根據以下主題生成 ${numAiQuestions} 個繁體中文的選擇測驗題目：「${aiTopic}」。
                    請將結果格式化為一個 JSON 陣列。
                    每個 JSON 物件代表一題，且必須包含以下四個鍵：
                    1. "text": (字串) 題目文字。
                    2. "options": (陣列) 一個包含四個選項的字串陣列。
                    3. "answer": (數字) 正確答案的 0-based 索引 (0, 1, 2, 或 3)。
                    4. "explanation": (字串) 題目的詳細解析。

                    請嚴格遵守這個 JSON 格式，不要包含任何 markdown 語法或額外的文字。
                    範例:
                    [
                      {
                        "text": "臺灣最高的山是哪一座？",
                        "options": ["雪山", "大霸尖山", "玉山", "南湖大山"],
                        "answer": 2,
                        "explanation": "玉山主峰海拔3,952公尺，是臺灣及東北亞的第一高峰。"
                      }
                    ]`;

                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        text: { type: "STRING", description: "題目文字" },
                                        options: {
                                            type: "ARRAY",
                                            description: "包含四個選項的字串陣列",
                                            items: { type: "STRING" }
                                        },
                                        answer: { type: "INTEGER", description: "正確答案的 0-based 索引" },
                                        explanation: { type: "STRING", description: "題目解析" }
                                    },
                                    required: ["text", "options", "answer", "explanation"]
                                }
                            }
                        }
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API 請求失敗，狀態碼：${response.status}. ${errorBody}`);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!generatedText) {
                        throw new Error('AI 未能生成有效的題目內容。');
                    }
                    
                    const parsedQuestions = JSON.parse(generatedText);

                    const validQuestions = parsedQuestions.map((q, index) => {
                        if (!q.text || !q.options || q.options.length !== 4 || typeof q.answer !== 'number' || q.answer < 0 || q.answer > 3 || !q.explanation) {
                            console.warn('AI 回傳了一筆格式不符的題目:', q);
                            return null;
                        }
                        return { ...q, id: Date.now() + index };
                    }).filter(Boolean);
                    
                    if (validQuestions.length === 0) {
                        throw new Error('AI 已處理完成，但未偵測到任何有效的題目。');
                    }

                    setQuestions(prev => [...prev, ...validQuestions]);
                    showAlert(`AI 成功生成了 ${validQuestions.length} 題新題目！`);

                } catch (error) {
                    console.error("AI 生成題目失敗:", error);
                    showAlert(`AI 生成題目失敗：${error.message}`);
                } finally {
                    setIsSimulatingAi(false);
                }
            };

            const handleAiOcrUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setIsSimulatingAi(true);

                try {
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });

                    const apiKey = "AIzaSyBrtW4nSsHfW8nExlIOSsLdZXnaPjVpwcM"; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const prompt = `分析這份文件圖片。它包含了測驗題目。請抽取出這些題目，並將它們格式化為一個 JSON 陣列。每個物件應包含 'text' (題目文字), 'options' (一個包含四個選項字串的陣列), 'answer' (正確答案的 0-based 索引，一個數字), 以及 'explanation' (解析文字)。請確保選項陣列正好有四個選項。
                    範例:
                    [
                      { 
                        "text": "臺灣最高的山是哪一座？", 
                        "options": ["雪山", "大霸尖山", "玉山", "南湖大山"], 
                        "answer": 2, 
                        "explanation": "玉山主峰海拔3,952公尺，是臺灣及東北亞的第一高峰。" 
                      }
                    ]`;

                    const payload = {
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: file.type, data: base64Data } }
                            ]
                        }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        text: { type: "STRING", description: "題目文字" },
                                        options: {
                                            type: "ARRAY",
                                            description: "包含四個選項的字串陣列",
                                            items: { type: "STRING" }
                                        },
                                        answer: { type: "INTEGER", description: "正確答案的 0-based 索引" },
                                        explanation: { type: "STRING", description: "題目解析" }
                                    },
                                    required: ["text", "options", "answer", "explanation"]
                                }
                            }
                        }
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API 請求失敗，狀態碼：${response.status}. ${errorBody}`);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!generatedText) {
                        throw new Error('AI 未能生成有效的題目內容。');
                    }

                    const parsedQuestions = JSON.parse(generatedText);

                    const validQuestions = parsedQuestions.map((q, index) => {
                        if (!q.text || !q.options || q.options.length !== 4 || typeof q.answer !== 'number' || q.answer < 0 || q.answer > 3 || !q.explanation) {
                            console.warn('AI 回傳了一筆格式不符的題目:', q);
                            return null;
                        }
                        return { ...q, id: Date.now() + index };
                    }).filter(Boolean);

                    if (validQuestions.length === 0) {
                        throw new Error('AI 已處理完成，但未偵測到任何有效的題目。');
                    }

                    setQuestions(prev => [...prev, ...validQuestions]);
                    showAlert(`AI 辨識成功！已加入 ${validQuestions.length} 題新題目。`);

                } catch (error) {
                    console.error("AI 辨識失敗:", error);
                    showAlert(`AI 辨識失敗：${error.message}`);
                } finally {
                    setIsSimulatingAi(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = "";
                    }
                }
            };


            const handleDownloadExampleXLSX = () => {
                if (typeof XLSX === 'undefined') {
                    showAlert('錯誤：所需函式庫 (xlsx) 未載入。'); return;
                }
                const headers = ["text", "option1", "option2", "option3", "option4", "answer", "explanation"];
                const exampleRow1 = ["臺灣最高的山是哪一座？", "雪山", "大霸尖山", "玉山", "南湖大山", "C", "玉山主峰海拔3,952公尺，是臺灣及東北亞的第一高峰。"];
                const exampleRow2 = ["聲音在哪種介質中傳播最快？", "空氣", "水", "真空", "鋼鐵", "D", "聲音是機械波，需要在越緻密的介質中傳播越快。"];
                const data = [headers, exampleRow1, exampleRow2];
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Questions");
                XLSX.writeFile(wb, "quiz_template.xlsx");
                showAlert("已開始下載 .xlsx 範例檔。");
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (typeof XLSX === 'undefined') {
                    showAlert('錯誤：所需函式庫 (xlsx) 未載入，無法解析檔案。');
                    e.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        if (json.length === 0) { showAlert('檔案為空或格式不符。'); return; }

                        const newQuestions = json.map((row, index) => {
                            if (!row.text || String(row.text).trim() === '') return null;
                            const answerLetter = String(row.answer || '').toUpperCase().trim();
                            const answerIndex = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 }[answerLetter];
                            if (!row.option1 || !row.option2 || !row.option3 || !row.option4 || answerIndex === undefined || !row.explanation) {
                                throw new Error(`Excel中的第 ${index + 2} 行資料格式錯誤或不完整。`);
                            }
                            return {
                                id: Date.now() + index,
                                text: String(row.text),
                                options: [String(row.option1), String(row.option2), String(row.option3), String(row.option4)],
                                answer: answerIndex,
                                explanation: String(row.explanation),
                            };
                        }).filter(Boolean);

                        if (newQuestions.length === 0) { showAlert('檔案中沒有找到有效的題目資料。'); return; }

                        setQuestions(prev => [...prev, ...newQuestions]);
                        showAlert(`成功匯入 ${newQuestions.length} 題！`);

                    } catch (error) {
                        console.error("檔案解析錯誤:", error);
                        showAlert(`檔案處理失敗：${error.message}`);
                    } finally {
                        e.target.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleDeleteConfirm = () => {
                setQuestions(prev => prev.filter(q => q.id !== deletingQuestionId));
                setDeletingQuestionId(null);
            };

            const handleUpdateQuestion = (updatedQuestion) => {
                setQuestions(prev => prev.map(q => q.id === updatedQuestion.id ? updatedQuestion : q));
                setEditingQuestion(null);
                showAlert('題目更新成功！');
            };
            
            return (
                <div className="relative">
                    {isSimulatingAi && <LoadingSpinner />}
                    {editingQuestion && <EditQuestionModal question={editingQuestion} onSave={handleUpdateQuestion} onCancel={() => setEditingQuestion(null)} />}
                    {deletingQuestionId && (
                         <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                             <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                                 <h3 className="text-lg font-bold mb-4">確定要刪除嗎？</h3>
                                 <p>刪除後將無法復原，確定要刪除這道題目嗎？</p>
                                 <div className="flex justify-end gap-4 mt-6">
                                     <button onClick={() => setDeletingQuestionId(null)} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                                     <button onClick={handleDeleteConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">確定刪除</button>
                                 </div>
                             </div>
                         </div>
                    )}
                    <div>
                        <div className="flex flex-wrap gap-2 mb-6 border-b pb-2">
                            <button onClick={() => setImportMethod('manual')} className={`px-4 py-2 rounded-lg ${importMethod === 'manual' ? 'bg-blue-600 text-white' : 'bg-slate-200'}`}>手動輸入</button>
                            <button onClick={() => setImportMethod('excel')} className={`px-4 py-2 rounded-lg ${importMethod === 'excel' ? 'bg-blue-600 text-white' : 'bg-slate-200'}`}>Excel匯入</button>
                            <button onClick={() => setImportMethod('ai-ocr')} className={`px-4 py-2 rounded-lg ${importMethod === 'ai-ocr' ? 'bg-blue-600 text-white' : 'bg-slate-200'}`}>AI圖片/PDF辨識</button>
                            <button onClick={() => setImportMethod('ai-gen')} className={`px-4 py-2 rounded-lg ${importMethod === 'ai-gen' ? 'bg-blue-600 text-white' : 'bg-slate-200'}`}>AI主題出題</button>
                        </div>
                        
                        <div>
                            {importMethod === 'manual' && <ManualQuestionEntry setQuestions={setQuestions} showAlert={showAlert} />}
                            {importMethod === 'excel' && (
                                <div className="p-4 bg-slate-50 rounded-lg">
                                    <h4 className="font-bold text-lg mb-2">從 Excel 檔案整批匯入</h4>
                                    <p className="mb-4 text-slate-600">請上傳 .xlsx 格式的檔案。欄位需符合範例檔格式。</p>
                                    <button onClick={handleDownloadExampleXLSX} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-4">下載 XLSX 範例檔</button>
                                    <input type="file" accept=".xlsx" onChange={handleFileUpload} className="text-sm" />
                                </div>
                            )}
                            {importMethod === 'ai-ocr' && (
                                <div className="p-4 bg-slate-50 rounded-lg">
                                    <h4 className="font-bold text-lg mb-2">AI 智慧辨識 (圖片/PDF)</h4>
                                    <p className="mb-4 text-slate-600">上傳包含題目的圖片或PDF檔案，AI將自動辨識並轉換為測驗題目。</p>
                                    <input type="file" ref={fileInputRef} accept="image/*,.pdf" onChange={handleAiOcrUpload} className="text-sm" />
                                </div>
                            )}
                            {importMethod === 'ai-gen' && (
                                <div className="p-4 bg-slate-50 rounded-lg">
                                    <h4 className="font-bold text-lg mb-2">AI 智慧出題</h4>
                                    <p className="mb-4 text-slate-600">輸入一個主題或一段教材內容，AI 將為您生成相關的測驗題目。</p>
                                    <textarea value={aiTopic} onChange={(e) => setAiTopic(e.target.value)} placeholder="例如：臺灣近代史、光合作用、牛頓第二運動定律..." className="w-full p-2 border rounded-lg mb-2 h-24"></textarea>
                                    <div className="flex items-center gap-4">
                                        <div>
                                            <label htmlFor="numAiQuestions" className="font-semibold mr-2">題目數量:</label>
                                            <input 
                                                id="numAiQuestions"
                                                type="number" 
                                                value={numAiQuestions} 
                                                onChange={e => setNumAiQuestions(Math.max(1, parseInt(e.target.value) || 1))} 
                                                className="w-20 p-2 border rounded-lg"
                                                min="1"
                                            />
                                        </div>
                                        <button onClick={handleAiGenerateByTopic} disabled={!aiTopic} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-300">開始生成</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex justify-between items-center mt-8 mb-4 border-t pt-6">
                            <h3 className="text-xl font-bold">主題「{themeName}」題庫 ({questions.length} 題)</h3>
                            <div className="flex items-center gap-2">
                                <span className="font-semibold text-slate-600">允許重複測驗:</span>
                                <label className="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked={themeSettings?.allowRetakes || false} onChange={handleRetakeToggle} className="sr-only peer" />
                                    <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>

                        <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                            {questions.map((q, index) => {
                                const stats = questionStats[q.text];
                                const hasStats = stats && stats.attempts > 0;
                                const correctRate = hasStats ? Math.round((stats.correct / stats.attempts) * 100) : 0;
                                return (
                                <div key={q.id} className="p-3 bg-white rounded-lg border flex justify-between items-start gap-4">
                                    <div className="flex-grow">
                                        <p className="font-semibold break-words">{`${index + 1}. ${q.text}`}</p>
                                        {hasStats ? (
                                            <div className="text-sm mt-2 text-slate-600">
                                                <div className="flex items-center gap-3 flex-wrap">
                                                    <span className="font-medium">答對率: <span className="font-bold text-lg text-blue-600">{correctRate}%</span> ({stats.correct} / {stats.attempts} 次)</span>
                                                    <div className="w-full max-w-[200px] h-2.5 bg-red-200 rounded-full overflow-hidden">
                                                        <div className="h-full bg-green-500" style={{ width: `${correctRate}%` }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            <p className="text-sm mt-2 text-slate-400 italic">尚無作答紀錄</p>
                                        )}
                                        <p className="text-sm text-slate-500 mt-2">答案: {q.options[q.answer]}</p>
                                    </div>
                                    <div className="flex-shrink-0 flex flex-col gap-2">
                                        <button onClick={() => setEditingQuestion(q)} className="text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md">編輯</button>
                                        <button onClick={() => setDeletingQuestionId(q.id)} className="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md">刪除</button>
                                    </div>
                                </div>
                                );
                            })}
                             {questions.length === 0 && <p className="text-slate-500 text-center py-4">這個主題還沒有題目，快來新增吧！</p>}
                        </div>
                    </div>
                </div>
            );
        }

        function ManualQuestionEntry({ setQuestions, showAlert }) {
            const [text, setText] = useState('');
            const [options, setOptions] = useState(['', '', '', '']);
            const [answer, setAnswer] = useState(0);
            const [explanation, setExplanation] = useState('');
            
            const handleOptionChange = (index, value) => {
                const newOptions = [...options];
                newOptions[index] = value;
                setOptions(newOptions);
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (text && options.every(o => o) && explanation) {
                    const newQuestion = { id: Date.now(), text, options, answer, explanation };
                    setQuestions(prev => [newQuestion, ...prev]);
                    setText(''); setOptions(['', '', '', '']); setAnswer(0); setExplanation('');
                    showAlert('題目新增成功！');
                } else {
                    showAlert('請填寫所有欄位！');
                }
            };

            return (
                <form onSubmit={handleSubmit} className="p-4 bg-slate-50 rounded-lg space-y-4">
                    <div>
                        <label className="font-bold">題目內容</label>
                        <input type="text" value={text} onChange={e => setText(e.target.value)} className="w-full p-2 border rounded mt-1" />
                    </div>
                    <div>
                        <label className="font-bold">選項 (請點選正確答案)</label>
                        {options.map((opt, index) => (
                            <div key={index} className="flex items-center mt-1">
                                <input type="radio" name="correct-answer" checked={answer === index} onChange={() => setAnswer(index)} className="mr-2 h-5 w-5 text-blue-600 focus:ring-blue-500" />
                                <input type="text" value={opt} onChange={e => handleOptionChange(index, e.target.value)} placeholder={`選項 ${index + 1}`} className="w-full p-2 border rounded" />
                            </div>
                        ))}
                    </div>
                     <div>
                        <label className="font-bold">解析</label>
                        <textarea value={explanation} onChange={e => setExplanation(e.target.value)} className="w-full p-2 border rounded mt-1 h-20"></textarea>
                    </div>
                    <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">新增題目</button>
                </form>
            );
        }

        function EditQuestionModal({ question, onSave, onCancel }) {
            const [editedQuestion, setEditedQuestion] = useState(question);

            const handleOptionChange = (index, value) => {
                const newOptions = [...editedQuestion.options];
                newOptions[index] = value;
                setEditedQuestion({ ...editedQuestion, options: newOptions });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(editedQuestion);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" onClick={onCancel}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-2xl font-bold mb-4">編輯題目</h3>
                        <form onSubmit={handleSubmit} className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                            <div>
                                <label className="font-bold">題目內容</label>
                                <input type="text" value={editedQuestion.text} onChange={(e) => setEditedQuestion({...editedQuestion, text: e.target.value})} className="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label className="font-bold">選項與正確答案</label>
                                {editedQuestion.options.map((opt, index) => (
                                    <div key={index} className="flex items-center mt-1">
                                        <input type="radio" name="correct-answer-edit" checked={editedQuestion.answer === index} onChange={() => setEditedQuestion({...editedQuestion, answer: index})} className="mr-2 h-5 w-5 text-blue-600" />
                                        <input type="text" value={opt} onChange={e => handleOptionChange(index, e.target.value)} placeholder={`選項 ${index + 1}`} className="w-full p-2 border rounded" />
                                    </div>
                                ))}
                            </div>
                            <div>
                                <label className="font-bold">解析</label>
                                <textarea value={editedQuestion.explanation} onChange={(e) => setEditedQuestion({...editedQuestion, explanation: e.target.value})} className="w-full p-2 border rounded mt-1 h-20"></textarea>
                            </div>
                            <div className="flex justify-end gap-4 pt-4 border-t">
                                <button type="button" onClick={onCancel} className="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                                <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">儲存變更</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function AddThemeModal({ onSave, onCancel }) {
            const [themeName, setThemeName] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onSave(themeName.trim()); };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 className="text-lg font-bold mb-4">新增測驗主題</h3>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="text" value={themeName} onChange={(e) => setThemeName(e.target.value)}
                                placeholder="請輸入新主題的名稱"
                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" autoFocus
                            />
                            <div className="flex justify-end gap-4 mt-6">
                                <button type="button" onClick={onCancel} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                                <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">確定新增</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function DeleteThemeModal({ themeName, onConfirm, onCancel }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 className="text-lg font-bold mb-4">確認刪除主題</h3>
                        <p>您確定要刪除「<span className="font-bold text-red-600">{themeName}</span>」主題嗎？</p>
                        <p className="text-sm text-slate-600 mt-2">此主題下的所有題目將會被一併刪除，此操作無法復原。</p>
                        <div className="flex justify-end gap-4 mt-6">
                            <button onClick={onCancel} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                            <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">確定刪除</button>
                        </div>
                    </div>
                </div>
            );
        }

        function LoadingSpinner() {
            return (
                <div className="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-20">
                    <div className="flex flex-col items-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
                        <p className="mt-4 text-lg font-semibold text-blue-600">AI 處理中，請稍候...</p>
                    </div>
                </div>
            );
        }

        function TeacherPasswordModal({ onLogin, onCancel }) {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onLogin(password); };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 className="text-lg font-bold mb-4">教師登入</h3>
                        <form onSubmit={handleSubmit}>
                            <label className="block text-sm font-medium text-slate-600 mb-1">請輸入密碼</label>
                            <input
                                type="password" value={password} onChange={(e) => setPassword(e.target.value)}
                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" autoFocus
                            />
                            <div className="flex justify-end gap-4 mt-6">
                                <button type="button" onClick={onCancel} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                                <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">登入</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ChangePasswordModal({ onSave, onCancel }) {
            const [oldPassword, setOldPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                if (!newPassword || !oldPassword) { setError('所有欄位皆為必填！'); return; }
                if (newPassword !== confirmPassword) { setError('新密碼與確認密碼不相符！'); return; }
                onSave(oldPassword, newPassword);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 className="text-lg font-bold mb-4">修改密碼</h3>
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">舊密碼</label>
                                <input type="password" value={oldPassword} onChange={(e) => setOldPassword(e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">新密碼</label>
                                <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">確認新密碼</label>
                                 <input type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg" required />
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div className="flex justify-end gap-4 pt-4">
                                <button type="button" onClick={onCancel} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                                <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">儲存</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function AddClassModal({ onSave, onCancel }) {
            const [className, setClassName] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onSave(className.trim()); };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                    <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 className="text-lg font-bold mb-4">新增班級</h3>
                        <input
                            type="text" value={className} onChange={(e) => setClassName(e.target.value)}
                            placeholder="請輸入班級名稱 (例如: 703)"
                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" autoFocus
                        />
                        <div className="flex justify-end gap-4 mt-6">
                            <button type="button" onClick={onCancel} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                            <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">確定新增</button>
                        </div>
                    </form>
                </div>
            );
        }

        function AddEditStudentModal({ classKey, student, onSave, onCancel }) {
            const isEditing = !!student;
            const [seat, setSeat] = useState(isEditing ? student.seat : '');
            const [name, setName] = useState(isEditing ? student.name : '');
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!seat || !name) return;
                onSave(classKey, { seat: seat.trim(), name: name.trim() }, isEditing ? student.seat : undefined);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                    <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 className="text-lg font-bold mb-4">{isEditing ? `編輯學生 (${classKey} 班)` : `新增學生至 ${classKey} 班`}</h3>
                        <div className="space-y-4">
                             <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">座號</label>
                                <input type="text" value={seat} onChange={(e) => setSeat(e.target.value)} className="w-full p-2 border rounded" required autoFocus/>
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">姓名</label>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border rounded" required />
                            </div>
                        </div>
                        <div className="flex justify-end gap-4 mt-6">
                            <button type="button" onClick={onCancel} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                            <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">儲存</button>
                        </div>
                    </form>
                </div>
            );
        }

        function ConfirmDeleteModal({ title, message, onConfirm, onCancel }) {
             return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                        <h3 className="text-lg font-bold mb-4">{title}</h3>
                        <p>{message}</p>
                        <div className="flex justify-end gap-4 mt-6">
                            <button onClick={onCancel} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">取消</button>
                            <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">確定刪除</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Render the App ---
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
